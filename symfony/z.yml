# @version ">=2.0"

symfony: ~

tasks:
    _symfony.build.composer_install: |
        cd $(build.dir) && composer install --no-scripts --prefer-dist --optimize-autoloader

    _symfony.build.assets_install: |
        cd $(build.dir) && php $(path(symfony.root, symfony.console)) assets:install $(symfony.web) --env=$(target_env) --no-debug --symlink --relative;

    _symfony.build.assetic_dump: |
        cd $(build.dir) && php $(path(symfony.root, symfony.console)) assetic:dump --env=$(target_env) --no-debug;

    _symfony.env.flush_cache: |
        @(sh ssh(target_env))
        php $(path(envs[target_env].root, symfony.root, symfony.console)) cache:clear --env=$(target_env) --no-debug

    build:
        post:
            - @_symfony_build

    _symfony_build:
        do:
            - @_symfony.build.composer_install
            - @(if symfony.assets)  @_symfony.build.assets_install
            - @(if symfony.assetic) @_symfony.build.assetic_dump
    deploy:
        post:
            - @(if symfony.flush_cache) @_symfony.env.flush_cache

    symfony.logs:
        help: |
            Tail the logs at the specified environment.

            If run in verbose mode, the logs are cat'ed.
        args:
            target_env: ?
            level: ? ""
        flags:
            follow: false
        do: |
            @(sh ssh(target_env))
            tail $(follow ? "--follow") $(path(envs[target_env].root, symfony.root, "app/logs", target_env)).log